# Fluent Bit configuration for Claude Flow log aggregation

[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    Health_Check  On

# Input for Claude Flow application logs
[INPUT]
    Name              tail
    Path              /var/log/claude-flow/*.log
    Parser            json
    Tag               claude-flow.app
    Refresh_Interval  5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On

# Input for Claude Flow access logs
[INPUT]
    Name              tail
    Path              /var/log/claude-flow/access.log
    Parser            nginx
    Tag               claude-flow.access
    Refresh_Interval  5

# Input for system logs
[INPUT]
    Name              systemd
    Tag               system
    Systemd_Filter    _SYSTEMD_UNIT=docker.service
    Read_From_Tail    On

# Filter to add metadata
[FILTER]
    Name record_modifier
    Match claude-flow.*
    Record hostname ${HOSTNAME}
    Record service claude-flow
    Record environment production

# Filter to parse structured logs
[FILTER]
    Name parser
    Match claude-flow.app
    Key_Name log
    Parser json
    Reserve_Data On

# Output to stdout for debugging
[OUTPUT]
    Name  stdout
    Match *

# Output to Prometheus metrics
[OUTPUT]
    Name prometheus_exporter
    Match *
    Host 0.0.0.0
    Port 2021

# Optional: Output to Elasticsearch (uncomment if needed)
# [OUTPUT]
#     Name es
#     Match *
#     Host elasticsearch
#     Port 9200
#     Index claude-flow-logs
#     Type _doc

# Optional: Output to Loki (uncomment if needed)  
# [OUTPUT]
#     Name loki
#     Match *
#     Host loki
#     Port 3100
#     Labels job=claude-flow